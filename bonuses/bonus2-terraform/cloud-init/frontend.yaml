#cloud-config
# Cloud-init configuration for Frontend VM (VM1)
# Installs base packages and prepares for Ansible configuration

users:
  - name: ${ssh_user}
    groups: sudo, docker
    shell: /bin/bash
    sudo: ['ALL=(ALL) NOPASSWD:ALL']
    ssh_authorized_keys:
      - ${file("~/.ssh/id_rsa.pub")}

package_update: true
package_upgrade: true

packages:
  - apt-transport-https
  - ca-certificates
  - curl
  - gnupg
  - lsb-release
  - git
  - vim
  - htop
  - net-tools
  - python3
  - python3-pip
  - ufw
  - fail2ban
  - nginx

timezone: ${timezone}

# Configure firewall
runcmd:
  # Set hostname
  - hostnamectl set-hostname vm1-frontend
  
  # Enable UFW firewall
  - ufw default deny incoming
  - ufw default allow outgoing
  - ufw allow 22/tcp
  - ufw allow 80/tcp
  - ufw allow 443/tcp
  - ufw allow 3000/tcp
  - ufw --force enable
  
  # Install Docker
  - curl -fsSL https://download.docker.com/linux/ubuntu/gpg | gpg --dearmor -o /usr/share/keyrings/docker-archive-keyring.gpg
  - echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/docker-archive-keyring.gpg] https://download.docker.com/linux/ubuntu $(lsb_release -cs) stable" | tee /etc/apt/sources.list.d/docker.list > /dev/null
  - apt-get update
  - apt-get install -y docker-ce docker-ce-cli containerd.io docker-compose-plugin
  - systemctl enable docker
  - systemctl start docker
  - usermod -aG docker ${ssh_user}
  
  # Install Node.js 20 LTS
  - curl -fsSL https://deb.nodesource.com/setup_20.x | bash -
  - apt-get install -y nodejs
  
  # Create project directories
  - mkdir -p /opt/${project_name}/frontend
  - mkdir -p /var/log/${project_name}
  - mkdir -p /etc/${project_name}/nginx
  - chown -R ${ssh_user}:${ssh_user} /opt/${project_name}
  - chown -R ${ssh_user}:${ssh_user} /var/log/${project_name}
  
  # Configure fail2ban
  - systemctl enable fail2ban
  - systemctl start fail2ban
  
  # Signal completion
  - echo "Cloud-init completed for ${project_name} frontend VM" > /var/log/cloud-init-complete.log

final_message: "Frontend VM initialization complete after $UPTIME seconds"

