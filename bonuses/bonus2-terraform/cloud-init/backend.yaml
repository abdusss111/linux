#cloud-config
# Cloud-init configuration for Backend VM (VM2)
# Installs base packages, PostgreSQL, and prepares for Ansible configuration

users:
  - name: ${ssh_user}
    groups: sudo, docker
    shell: /bin/bash
    sudo: ['ALL=(ALL) NOPASSWD:ALL']
    ssh_authorized_keys:
      - ${file("~/.ssh/id_rsa.pub")}

package_update: true
package_upgrade: true

packages:
  - apt-transport-https
  - ca-certificates
  - curl
  - gnupg
  - lsb-release
  - git
  - vim
  - htop
  - net-tools
  - python3
  - python3-pip
  - python3-venv
  - ufw
  - fail2ban
  - postgresql
  - postgresql-contrib

timezone: ${timezone}

# Configure PostgreSQL
write_files:
  - path: /tmp/init_db.sql
    content: |
      CREATE USER dapmeet WITH PASSWORD '${db_password}';
      CREATE DATABASE dapmeet OWNER dapmeet;
      GRANT ALL PRIVILEGES ON DATABASE dapmeet TO dapmeet;
    permissions: '0600'

runcmd:
  # Set hostname
  - hostnamectl set-hostname vm2-backend
  
  # Enable UFW firewall
  - ufw default deny incoming
  - ufw default allow outgoing
  - ufw allow 22/tcp
  - ufw allow from ${frontend_ip} to any port 8000
  - ufw allow from ${frontend_ip} to any port 5432
  - ufw --force enable
  
  # Install Docker
  - curl -fsSL https://download.docker.com/linux/ubuntu/gpg | gpg --dearmor -o /usr/share/keyrings/docker-archive-keyring.gpg
  - echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/docker-archive-keyring.gpg] https://download.docker.com/linux/ubuntu $(lsb_release -cs) stable" | tee /etc/apt/sources.list.d/docker.list > /dev/null
  - apt-get update
  - apt-get install -y docker-ce docker-ce-cli containerd.io docker-compose-plugin
  - systemctl enable docker
  - systemctl start docker
  - usermod -aG docker ${ssh_user}
  
  # Configure PostgreSQL
  - systemctl enable postgresql
  - systemctl start postgresql
  - |
    sudo -u postgres psql -f /tmp/init_db.sql || true
  - |
    # Allow connections from frontend
    echo "host    dapmeet    dapmeet    ${frontend_ip}/32    md5" >> /etc/postgresql/14/main/pg_hba.conf
    echo "listen_addresses = '*'" >> /etc/postgresql/14/main/postgresql.conf
  - systemctl restart postgresql
  - rm /tmp/init_db.sql
  
  # Create project directories
  - mkdir -p /opt/${project_name}/backend
  - mkdir -p /var/${project_name}/processing
  - mkdir -p /var/log/${project_name}
  - mkdir -p /var/backups/${project_name}/postgresql
  - mkdir -p /etc/${project_name}/backend
  - chown -R ${ssh_user}:${ssh_user} /opt/${project_name}
  - chown -R ${ssh_user}:${ssh_user} /var/${project_name}
  - chown -R ${ssh_user}:${ssh_user} /var/log/${project_name}
  
  # Configure fail2ban
  - systemctl enable fail2ban
  - systemctl start fail2ban
  
  # Signal completion
  - echo "Cloud-init completed for ${project_name} backend VM" > /var/log/cloud-init-complete.log

final_message: "Backend VM initialization complete after $UPTIME seconds"

