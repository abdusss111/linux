---
# GitHub Actions Workflow for Ansible Deployment
# This workflow runs the SIS5 Ansible playbook on your VMs
# Bonus Task 1: CI/CD Integration with GitHub Actions

name: Deploy Dapmeet Infrastructure

on:
  push:
    branches:
      - main
    paths:
      - 'sis5/ansible/**'
      - '.github/workflows/ansible-deploy.yml'
  pull_request:
    branches:
      - main
    paths:
      - 'sis5/ansible/**'
  workflow_dispatch:  # Manual trigger
    inputs:
      environment:
        description: 'Target environment'
        required: true
        default: 'staging'
        type: choice
        options:
          - staging
          - production
      playbook:
        description: 'Playbook to run'
        required: true
        default: 'site.yml'
        type: choice
        options:
          - site.yml
          - vm1.yml
          - vm2.yml
      tags:
        description: 'Ansible tags to run (comma-separated, leave empty for all)'
        required: false
        default: ''

env:
  ANSIBLE_FORCE_COLOR: '1'
  ANSIBLE_HOST_KEY_CHECKING: 'false'
  PYTHON_VERSION: '3.11'

jobs:
  lint:
    name: Lint Ansible Playbooks
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install ansible-lint
        run: |
          pip install ansible-lint yamllint

      - name: Lint YAML files
        run: |
          yamllint -c .yamllint.yml sis5/ansible/ || true

      - name: Lint Ansible playbooks
        run: |
          cd sis5/ansible
          ansible-lint playbooks/*.yml || true

  syntax-check:
    name: Ansible Syntax Check
    runs-on: ubuntu-latest
    needs: lint
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install Ansible
        run: |
          pip install ansible

      - name: Check playbook syntax
        run: |
          cd sis5/ansible
          ansible-playbook --syntax-check -i inventory/hosts.yml playbooks/site.yml

  deploy:
    name: Deploy to VMs
    runs-on: ubuntu-latest
    needs: syntax-check
    if: github.event_name == 'workflow_dispatch' || (github.event_name == 'push' && github.ref == 'refs/heads/main')
    environment:
      name: ${{ github.event.inputs.environment || 'staging' }}
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install Ansible and dependencies
        run: |
          pip install ansible docker requests

      - name: Install Ansible Galaxy requirements
        run: |
          cd sis5/ansible
          ansible-galaxy install -r requirements.yml --force

      - name: Configure SSH key
        env:
          SSH_PRIVATE_KEY: ${{ secrets.ANSIBLE_SSH_PRIVATE_KEY }}
        run: |
          mkdir -p ~/.ssh
          echo "$SSH_PRIVATE_KEY" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          
          # Add VM hosts to known_hosts
          ssh-keyscan -H ${{ secrets.VM1_HOST }} >> ~/.ssh/known_hosts 2>/dev/null || true
          ssh-keyscan -H ${{ secrets.VM2_HOST }} >> ~/.ssh/known_hosts 2>/dev/null || true

      - name: Create dynamic inventory
        env:
          VM1_HOST: ${{ secrets.VM1_HOST }}
          VM2_HOST: ${{ secrets.VM2_HOST }}
          ANSIBLE_USER: ${{ secrets.ANSIBLE_USER }}
        run: |
          cat > sis5/ansible/inventory/dynamic-hosts.yml << EOF
          ---
          all:
            children:
              frontend:
                hosts:
                  vm1:
                    ansible_host: ${VM1_HOST}
                    ansible_user: ${ANSIBLE_USER}
              backend:
                hosts:
                  vm2:
                    ansible_host: ${VM2_HOST}
                    ansible_user: ${ANSIBLE_USER}
            vars:
              ansible_python_interpreter: /usr/bin/python3
              project_name: dapmeet
              domain_name: dapmeet.local
          EOF

      - name: Run Ansible Playbook
        env:
          ANSIBLE_BECOME_PASS: ${{ secrets.ANSIBLE_BECOME_PASSWORD }}
        run: |
          cd sis5/ansible
          
          # Determine playbook and tags
          PLAYBOOK="${{ github.event.inputs.playbook || 'site.yml' }}"
          TAGS="${{ github.event.inputs.tags }}"
          
          # Build ansible-playbook command
          CMD="ansible-playbook -i inventory/dynamic-hosts.yml playbooks/${PLAYBOOK}"
          
          # Add tags if specified
          if [ -n "$TAGS" ]; then
            CMD="${CMD} --tags ${TAGS}"
          fi
          
          # Add verbose output for debugging
          CMD="${CMD} -v"
          
          echo "Running: ${CMD}"
          eval ${CMD}

      - name: Verify deployment
        run: |
          cd sis5/ansible
          ansible-playbook -i inventory/dynamic-hosts.yml playbooks/verify.yml || true

      - name: Upload Ansible logs
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: ansible-logs
          path: |
            sis5/ansible/*.log
          retention-days: 7

  notify:
    name: Notify on completion
    runs-on: ubuntu-latest
    needs: deploy
    if: always()
    steps:
      - name: Send notification
        run: |
          STATUS="${{ needs.deploy.result }}"
          if [ "$STATUS" == "success" ]; then
            echo "✅ Deployment successful!"
          else
            echo "❌ Deployment failed!"
          fi

