---
# Role: services
# Purpose: Create systemd services as defined in SIS4

- name: Determine container service configuration
  ansible.builtin.set_fact:
    service_container_name: "{{ container_name | default(docker_container.name | default('dapmeet-frontend' if ('frontend' in group_names or (vm_role | default('')) == 'frontend') else 'dapmeet-backend')) }}"
    is_frontend_role: >-
      {{ 'frontend' in group_names or (vm_role | default('')) == 'frontend' }}
    default_hub_user: "{{ docker_hub_user | default('abdusss111') }}"

- name: Determine container image
  ansible.builtin.set_fact:
    service_container_image: >-
      {{ container_image | default(docker_container.image | default(frontend_image
      | default(default_hub_user ~ '/dapmeet-client:latest') if is_frontend_role
      else backend_image | default(default_hub_user ~
      '/dapmeet-service:latest'))) }}
    service_container_ports: >-
      {{ container_ports | default(docker_container.ports | default(['3000:3000']
      if is_frontend_role else ['8000:8000'])) }}
    service_container_env: "{{ docker_container.env | default({}) }}"
  tags: [services, systemd]

- name: Create systemd service for Docker container
  ansible.builtin.template:
    src: docker-container.service.j2
    dest: "/etc/systemd/system/{{ service_container_name }}.service"
    mode: "0644"
  notify:
    - Reload systemd
    - Restart container service
  tags: [services, systemd]

- name: Enable container service
  ansible.builtin.systemd:
    name: "{{ service_container_name }}"
    enabled: true
    daemon_reload: true
  tags: [services, systemd]

- name: Ensure container service is running
  ansible.builtin.systemd:
    name: "{{ service_container_name }}"
    state: started
  tags: [services, systemd]
