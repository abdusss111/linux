---
# Role: cron
# Purpose: Set up scheduled tasks as defined in SIS4

- name: Ensure cron is installed
  ansible.builtin.apt:
    name: cron
    state: present
  tags: [cron]

- name: Ensure cron service is running
  ansible.builtin.systemd:
    name: cron
    state: started
    enabled: true
  tags: [cron]

- name: Deploy maintenance scripts
  ansible.builtin.template:
    src: "{{ item }}.j2"
    dest: "{{ project_base }}/scripts/{{ item }}"
    mode: "0755"
    owner: root
    group: dapmeet
  loop:
    - backup_frontend_logs.sh
    - check_ssl_renewal.sh
    - backup_postgres.sh
    - cleanup_processing.sh
    - rotate_backend_logs.sh
  failed_when: false
  tags: [cron, scripts]

- name: Create cron jobs
  ansible.builtin.cron:
    name: "{{ item.name }}"
    job: "{{ item.job }}"
    minute: "{{ item.minute | default('*') }}"
    hour: "{{ item.hour | default('*') }}"
    day: "{{ item.day | default('*') }}"
    month: "{{ item.month | default('*') }}"
    weekday: "{{ item.weekday | default('*') }}"
    user: "{{ item.user }}"
    state: present
  loop: "{{ cron_jobs }}"
  tags: [cron]

