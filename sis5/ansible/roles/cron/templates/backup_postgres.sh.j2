#!/bin/bash
# PostgreSQL daily backup script
# Runs daily at 3:00 AM

set -e

BACKUP_DIR="{{ project_backups | default('/var/backups/dapmeet') }}/postgresql"
DATE=$(date +%Y%m%d_%H%M%S)
BACKUP_FILE="$BACKUP_DIR/dapmeet_$DATE.sql.gz"

mkdir -p "$BACKUP_DIR"

# Create backup using pg_dump
sudo -u postgres pg_dump dapmeet | gzip > "$BACKUP_FILE"

# Set proper permissions
chown backup:postgres "$BACKUP_FILE"
chmod 640 "$BACKUP_FILE"

# Remove backups older than 7 days
find "$BACKUP_DIR" -name "dapmeet_*.sql.gz" -mtime +7 -delete

echo "PostgreSQL backup completed: $BACKUP_FILE"

