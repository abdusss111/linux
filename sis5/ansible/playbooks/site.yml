---
# Main playbook: Complete Dapmeet infrastructure setup
# This playbook automates the setup described in SIS 2, 3, and 4

- name: Setup Dapmeet Infrastructure
  hosts: all
  become: true
  gather_facts: true

  pre_tasks:
    - name: Update apt cache
      ansible.builtin.apt:
        update_cache: true
        cache_valid_time: 3600
      tags: [always]

    - name: Install common packages
      ansible.builtin.apt:
        name:
          - vim
          - curl
          - wget
          - git
          - htop
          - net-tools
          - python3
          - python3-pip
        state: present
      tags: [common]

    - name: Set timezone
      community.general.timezone:
        name: "{{ timezone | default('UTC') }}"
      tags: [common]

  roles:
    # SIS2: Users and Permissions
    - role: users
      tags: [sis2, users]

    - role: permissions
      tags: [sis2, permissions]

    - role: ssh
      tags: [sis2, ssh]

    # SIS3: Networking and Firewall
    - role: firewall
      tags: [sis3, firewall]

    # SIS4: Docker, Services, and Cron
    - role: docker
      tags: [sis4, docker]

    - role: services
      tags: [sis4, services]

    - role: cron
      tags: [sis4, cron]

  post_tasks:
    - name: Set VM role for display
      ansible.builtin.set_fact:
        display_vm_role: "{{ vm_role | default('frontend' if 'frontend' in group_names else 'backend') }}"
        display_container_name: >-
          {{ docker_container.name | default('dapmeet-frontend' if
          ('frontend' in group_names or (vm_role | default('')) == 'frontend')
          else 'dapmeet-backend') }}
        display_container_ports: >-
          {{ docker_container.ports | default(['3000:3000'] if
          ('frontend' in group_names or (vm_role | default('')) == 'frontend')
          else ['8000:8000']) }}
      tags: [always]

    - name: Display setup completion message
      ansible.builtin.debug:
        msg: |
          Dapmeet setup completed on {{ inventory_hostname }}!
          VM Role: {{ display_vm_role }}
          Docker Container: {{ display_container_name }}
          Container Ports: {{ display_container_ports | join(', ') }}
      tags: [always]
