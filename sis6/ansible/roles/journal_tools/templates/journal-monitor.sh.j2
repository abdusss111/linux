#!/bin/bash
#==============================================================================
# Script: journal-monitor.sh
# Purpose: Real-time monitoring of journal logs with alerts
# Task 2: Journal toolset - Real-time monitoring
# Usage: journal-monitor.sh [OPTIONS]
#==============================================================================

set -euo pipefail

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
MAGENTA='\033[0;35m'
NC='\033[0m'
BOLD='\033[1m'

# Alert patterns from configuration
declare -A ALERT_PATTERNS=(
{% for alert in journal_tools.alert_patterns %}
    ["{{ alert.pattern }}"]="{{ alert.severity }}|{{ alert.description }}"
{% endfor %}
)

# Severity colors
declare -A SEVERITY_COLORS=(
    ["info"]="$BLUE"
    ["warning"]="$YELLOW"
    ["error"]="$RED"
    ["critical"]="$MAGENTA"
)

UNIT=""
PRIORITY=""
HIGHLIGHT=true

usage() {
    cat << EOF
${CYAN}Real-Time Journal Monitor${NC}
${BLUE}=========================${NC}

Usage: $(basename "$0") [OPTIONS]

Options:
  -u, --unit SERVICE    Monitor specific service
  -p, --priority LEVEL  Filter by priority (emerg,alert,crit,err,warning,notice,info,debug)
  -a, --all             Show all messages (no filtering)
  -n, --no-highlight    Disable pattern highlighting
  -q, --quiet           Minimal output (alerts only)
  -h, --help            Show this help

Alert Patterns:
{% for alert in journal_tools.alert_patterns %}
  {{ alert.pattern | truncate(25) }} -> {{ alert.severity }} ({{ alert.description }})
{% endfor %}

Examples:
  $(basename "$0")                     # Monitor with alerts
  $(basename "$0") -u sshd             # Monitor SSH only
  $(basename "$0") -p err              # Errors only
  $(basename "$0") --quiet             # Alerts only

Press Ctrl+C to stop monitoring.

EOF
    exit 0
}

print_banner() {
    clear
    echo -e "${CYAN}"
    echo "╔════════════════════════════════════════════════════════════════════╗"
    echo "║                   REAL-TIME LOG MONITOR                            ║"
    echo "║                   $(date '+%Y-%m-%d %H:%M:%S')                              ║"
    echo "╚════════════════════════════════════════════════════════════════════╝"
    echo -e "${NC}"
    echo -e "${BLUE}Monitoring: ${YELLOW}${UNIT:-all units}${NC}"
    echo -e "${BLUE}Priority: ${YELLOW}${PRIORITY:-all}${NC}"
    echo -e "${BLUE}Press Ctrl+C to stop${NC}"
    echo ""
    echo -e "${YELLOW}────────────────────────────────────────────────────────────────────${NC}"
}

check_patterns() {
    local line="$1"
    
    for pattern in "${!ALERT_PATTERNS[@]}"; do
        if echo "$line" | grep -qi "$pattern"; then
            IFS='|' read -r severity description <<< "${ALERT_PATTERNS[$pattern]}"
            local color="${SEVERITY_COLORS[$severity]:-$NC}"
            echo -e "${color}${BOLD}[ALERT: $severity]${NC} ${color}$description${NC}"
            return 0
        fi
    done
    return 1
}

highlight_line() {
    local line="$1"
    
    if ! $HIGHLIGHT; then
        echo "$line"
        return
    fi
    
    # Color based on priority keywords
    if echo "$line" | grep -qiE "emerg|fatal|panic"; then
        echo -e "${MAGENTA}$line${NC}"
    elif echo "$line" | grep -qiE "crit|critical"; then
        echo -e "${RED}${BOLD}$line${NC}"
    elif echo "$line" | grep -qiE "error|err|fail"; then
        echo -e "${RED}$line${NC}"
    elif echo "$line" | grep -qiE "warn|warning"; then
        echo -e "${YELLOW}$line${NC}"
    elif echo "$line" | grep -qiE "notice|info"; then
        echo -e "${GREEN}$line${NC}"
    else
        echo "$line"
    fi
}

monitor_logs() {
    local cmd="journalctl -f --no-pager"
    
    [ -n "$UNIT" ] && cmd="$cmd -u $UNIT"
    [ -n "$PRIORITY" ] && cmd="$cmd -p $PRIORITY"
    
    print_banner
    
    $cmd 2>/dev/null | while IFS= read -r line; do
        # Check for alert patterns
        check_patterns "$line"
        
        # Print the line with highlighting
        if ! $QUIET; then
            highlight_line "$line"
        fi
    done
}

# Defaults
QUIET=false

# Parse arguments
while [[ $# -gt 0 ]]; do
    case $1 in
        -u|--unit) UNIT="$2"; shift 2 ;;
        -p|--priority) PRIORITY="$2"; shift 2 ;;
        -a|--all) UNIT=""; PRIORITY=""; shift ;;
        -n|--no-highlight) HIGHLIGHT=false; shift ;;
        -q|--quiet) QUIET=true; shift ;;
        -h|--help) usage ;;
        *) echo "Unknown option: $1"; usage ;;
    esac
done

# Handle Ctrl+C gracefully
trap 'echo -e "\n${GREEN}Monitoring stopped.${NC}"; exit 0' INT

monitor_logs


