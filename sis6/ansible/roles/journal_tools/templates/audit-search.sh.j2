#!/bin/bash
#==============================================================================
# Script: audit-search.sh
# Purpose: Search and analyze audit logs
# Task 2: Journal toolset - Audit log searching
# Usage: audit-search.sh [OPTIONS] [key]
#==============================================================================

set -euo pipefail

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

usage() {
    cat << EOF
${CYAN}Audit Log Search Tool${NC}
${BLUE}=====================${NC}

Usage: $(basename "$0") [OPTIONS] [key]

Options:
  -k, --key KEY         Search by audit key
  -u, --user USER       Search by user
  -f, --file FILE       Search by file path
  -c, --comm COMMAND    Search by command name
  -t, --type TYPE       Search by audit message type
  -s, --start TIME      Start time (today, recent, this-week, etc.)
  -e, --end TIME        End time
  -i, --interpret       Interpret numeric values
  -r, --raw             Show raw audit records
  -l, --list-keys       List all defined audit keys
  -S, --summary         Show audit summary
  -h, --help            Show this help

Predefined keys:
  sudoers_changes       Changes to sudoers files
  identity_changes      User/group modifications
  ssh_config_changes    SSH configuration changes
  privileged_cmd        Privileged command execution
  cron_changes          Cron job modifications
  systemd_changes       Systemd unit changes
  kernel_modules        Kernel module operations

Examples:
  $(basename "$0") sudoers_changes
  $(basename "$0") -k identity_changes -s today
  $(basename "$0") -u root -s recent
  $(basename "$0") -f /etc/passwd
  $(basename "$0") --summary

EOF
    exit 0
}

check_auditd() {
    if ! command -v ausearch &> /dev/null; then
        echo -e "${RED}Error: auditd is not installed${NC}"
        echo "Install with: sudo apt install auditd"
        exit 1
    fi
    
    if ! systemctl is-active --quiet auditd; then
        echo -e "${YELLOW}Warning: auditd service is not running${NC}"
    fi
}

list_keys() {
    echo -e "${CYAN}=== Defined Audit Keys ===${NC}"
    echo ""
    
    if [ -d /etc/audit/rules.d ]; then
        echo -e "${BLUE}From rules files:${NC}"
        grep -h "key=" /etc/audit/rules.d/*.rules 2>/dev/null | \
            grep -oP 'key=\K[^\s]+' | sort -u | while read key; do
            echo "  - $key"
        done
    fi
    
    echo ""
    echo -e "${BLUE}Currently loaded:${NC}"
    auditctl -l 2>/dev/null | grep -oP 'key=\K[^\s]+' | sort -u | while read key; do
        echo "  - $key"
    done
}

show_summary() {
    echo -e "${CYAN}=== Audit Summary ===${NC}"
    echo ""
    
    echo -e "${BLUE}Audit Status:${NC}"
    auditctl -s 2>/dev/null || echo "  Cannot get status"
    
    echo ""
    echo -e "${BLUE}Rules Count:${NC}"
    echo "  $(auditctl -l 2>/dev/null | wc -l) rules loaded"
    
    echo ""
    echo -e "${BLUE}Recent Events by Key:${NC}"
    for key in sudoers_changes identity_changes ssh_config_changes privileged_cmd; do
        count=$(ausearch -k "$key" --start today 2>/dev/null | grep -c "type=" || echo "0")
        if [ "$count" -gt 0 ]; then
            echo -e "  ${YELLOW}$key${NC}: $count events"
        else
            echo -e "  $key: 0 events"
        fi
    done
    
    echo ""
    echo -e "${BLUE}Failed Operations:${NC}"
    ausearch --success no --start today 2>/dev/null | head -20 || \
        echo "  No failed operations found"
}

search_audit() {
    local cmd="ausearch"
    local args=()
    
    [ -n "${KEY:-}" ] && args+=("-k" "$KEY")
    [ -n "${USER:-}" ] && args+=("-ua" "$USER")
    [ -n "${FILE:-}" ] && args+=("-f" "$FILE")
    [ -n "${COMM:-}" ] && args+=("-c" "$COMM")
    [ -n "${TYPE:-}" ] && args+=("-m" "$TYPE")
    [ -n "${START:-}" ] && args+=("--start" "$START")
    [ -n "${END:-}" ] && args+=("--end" "$END")
    $INTERPRET && args+=("-i")
    $RAW && args+=("-r")
    
    if [ ${#args[@]} -eq 0 ]; then
        echo -e "${RED}Error: No search criteria specified${NC}"
        usage
    fi
    
    echo -e "${CYAN}=== Audit Search Results ===${NC}"
    echo -e "${BLUE}Search: ${args[*]}${NC}"
    echo ""
    
    $cmd "${args[@]}" 2>/dev/null || echo -e "${YELLOW}No matching records found${NC}"
}

# Initialize
check_auditd

# Defaults
KEY=""
USER=""
FILE=""
COMM=""
TYPE=""
START="today"
END=""
INTERPRET=true
RAW=false

# Parse arguments
while [[ $# -gt 0 ]]; do
    case $1 in
        -k|--key) KEY="$2"; shift 2 ;;
        -u|--user) USER="$2"; shift 2 ;;
        -f|--file) FILE="$2"; shift 2 ;;
        -c|--comm) COMM="$2"; shift 2 ;;
        -t|--type) TYPE="$2"; shift 2 ;;
        -s|--start) START="$2"; shift 2 ;;
        -e|--end) END="$2"; shift 2 ;;
        -i|--interpret) INTERPRET=true; shift ;;
        -r|--raw) RAW=true; INTERPRET=false; shift ;;
        -l|--list-keys) list_keys; exit 0 ;;
        -S|--summary) show_summary; exit 0 ;;
        -h|--help) usage ;;
        -*) echo "Unknown option: $1"; usage ;;
        *) KEY="$1"; shift ;;
    esac
done

search_audit


