#!/bin/bash
#==============================================================================
# Script: journal-search.sh
# Purpose: Search specific patterns in systemd journal logs
# Task 2: Journal toolset - Pattern searching
# Usage: journal-search.sh [OPTIONS] <pattern>
#==============================================================================

set -euo pipefail

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

# Default values
SINCE="1 day ago"
UNTIL="now"
PRIORITY=""
UNIT=""
OUTPUT_FORMAT="short-iso"
CASE_INSENSITIVE=false
COUNT_ONLY=false
CONTEXT_LINES=0

usage() {
    cat << EOF
${CYAN}Journal Pattern Search Tool${NC}
${BLUE}============================${NC}

Usage: $(basename "$0") [OPTIONS] <pattern>

Options:
  -s, --since TIME      Start time (default: "1 day ago")
  -u, --until TIME      End time (default: "now")
  -p, --priority LEVEL  Filter by priority (emerg,alert,crit,err,warning,notice,info,debug)
  -U, --unit SERVICE    Filter by systemd unit
  -i, --ignore-case     Case insensitive search
  -c, --count           Show match count only
  -C, --context NUM     Show NUM lines of context
  -o, --output FORMAT   Output format (short, short-iso, verbose, json)
  -h, --help            Show this help

Examples:
  $(basename "$0") "Failed password"
  $(basename "$0") -s "2 hours ago" -p err "error"
  $(basename "$0") -U sshd -i "authentication"
  $(basename "$0") --count "sudo"

Predefined searches:
  $(basename "$0") --auth-failures     Show authentication failures
  $(basename "$0") --sudo-commands     Show sudo command usage
  $(basename "$0") --errors            Show all errors
  $(basename "$0") --critical          Show critical events

EOF
    exit 0
}

# Predefined searches
auth_failures() {
    echo -e "${YELLOW}=== Authentication Failures ===${NC}"
    journalctl --since="$SINCE" --until="$UNTIL" --no-pager \
        -g "Failed password|authentication failure|Access denied" \
        --output="$OUTPUT_FORMAT" 2>/dev/null || echo "No authentication failures found"
}

sudo_commands() {
    echo -e "${YELLOW}=== Sudo Command Usage ===${NC}"
    journalctl --since="$SINCE" --until="$UNTIL" --no-pager \
        _COMM=sudo --output="$OUTPUT_FORMAT" 2>/dev/null || echo "No sudo usage found"
}

show_errors() {
    echo -e "${YELLOW}=== Error Messages ===${NC}"
    journalctl --since="$SINCE" --until="$UNTIL" --no-pager \
        -p err --output="$OUTPUT_FORMAT" 2>/dev/null || echo "No errors found"
}

show_critical() {
    echo -e "${YELLOW}=== Critical Events ===${NC}"
    journalctl --since="$SINCE" --until="$UNTIL" --no-pager \
        -p crit --output="$OUTPUT_FORMAT" 2>/dev/null || echo "No critical events found"
}

search_pattern() {
    local pattern="$1"
    local cmd="journalctl --since=\"$SINCE\" --until=\"$UNTIL\" --no-pager"
    
    # Add unit filter
    [ -n "$UNIT" ] && cmd="$cmd -u $UNIT"
    
    # Add priority filter
    [ -n "$PRIORITY" ] && cmd="$cmd -p $PRIORITY"
    
    # Add output format
    cmd="$cmd --output=$OUTPUT_FORMAT"
    
    # Add grep options
    local grep_opts="-E"
    $CASE_INSENSITIVE && grep_opts="$grep_opts -i"
    [ $CONTEXT_LINES -gt 0 ] && grep_opts="$grep_opts -C $CONTEXT_LINES"
    
    if $COUNT_ONLY; then
        eval "$cmd" 2>/dev/null | grep $grep_opts "$pattern" | wc -l
    else
        echo -e "${CYAN}Searching for: ${YELLOW}$pattern${NC}"
        echo -e "${BLUE}Time range: $SINCE - $UNTIL${NC}"
        [ -n "$UNIT" ] && echo -e "${BLUE}Unit: $UNIT${NC}"
        [ -n "$PRIORITY" ] && echo -e "${BLUE}Priority: $PRIORITY${NC}"
        echo ""
        
        eval "$cmd" 2>/dev/null | grep $grep_opts --color=always "$pattern" || \
            echo -e "${YELLOW}No matches found${NC}"
    fi
}

# Parse arguments
while [[ $# -gt 0 ]]; do
    case $1 in
        -s|--since) SINCE="$2"; shift 2 ;;
        -u|--until) UNTIL="$2"; shift 2 ;;
        -p|--priority) PRIORITY="$2"; shift 2 ;;
        -U|--unit) UNIT="$2"; shift 2 ;;
        -i|--ignore-case) CASE_INSENSITIVE=true; shift ;;
        -c|--count) COUNT_ONLY=true; shift ;;
        -C|--context) CONTEXT_LINES="$2"; shift 2 ;;
        -o|--output) OUTPUT_FORMAT="$2"; shift 2 ;;
        -h|--help) usage ;;
        --auth-failures) auth_failures; exit 0 ;;
        --sudo-commands) sudo_commands; exit 0 ;;
        --errors) show_errors; exit 0 ;;
        --critical) show_critical; exit 0 ;;
        -*) echo "Unknown option: $1"; usage ;;
        *) PATTERN="$1"; shift ;;
    esac
done

if [ -z "${PATTERN:-}" ]; then
    echo -e "${RED}Error: No search pattern provided${NC}"
    usage
fi

search_pattern "$PATTERN"

