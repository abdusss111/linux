#!/bin/bash
#==============================================================================
# Script: log-analyzer.sh
# Purpose: Analyze and generate statistics from journal logs
# Task 2: Journal toolset - Log analysis
# Usage: log-analyzer.sh [OPTIONS]
#==============================================================================

set -euo pipefail

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
MAGENTA='\033[0;35m'
NC='\033[0m'

SINCE="1 day ago"
OUTPUT_DIR="{{ project_logs }}/reports"

usage() {
    cat << EOF
${CYAN}Log Analyzer Tool${NC}
${BLUE}=================${NC}

Usage: $(basename "$0") [OPTIONS]

Options:
  -s, --since TIME      Start time (default: "1 day ago")
  -o, --output DIR      Output directory for reports
  -h, --help            Show this help

Reports:
  --errors              Analyze error patterns
  --traffic             Analyze log traffic volume
  --services            Service activity analysis
  --users               User activity analysis
  --full                Full analysis (all reports)

Examples:
  $(basename "$0") --full
  $(basename "$0") --errors -s "6 hours ago"
  $(basename "$0") --services

EOF
    exit 0
}

print_header() {
    echo ""
    echo -e "${CYAN}╔══════════════════════════════════════════════════════════════╗${NC}"
    printf "${CYAN}║${NC} %-60s ${CYAN}║${NC}\n" "$1"
    echo -e "${CYAN}╚══════════════════════════════════════════════════════════════╝${NC}"
}

print_section() {
    echo ""
    echo -e "${YELLOW}┌─ $1 ─┐${NC}"
}

# Error analysis
analyze_errors() {
    print_header "Error Analysis"
    
    print_section "Error Distribution by Priority"
    echo ""
    for level in emerg alert crit err warning; do
        count=$(journalctl --since="$SINCE" -p $level --no-pager 2>/dev/null | wc -l)
        bar=$(printf '█%.0s' $(seq 1 $((count / 10 + 1))))
        printf "  %-10s %5d %s\n" "$level" "$count" "$bar"
    done
    
    print_section "Top Error Sources"
    echo ""
    journalctl --since="$SINCE" -p err --output=json --no-pager 2>/dev/null | \
        jq -r '.SYSLOG_IDENTIFIER // ._COMM // "unknown"' 2>/dev/null | \
        sort | uniq -c | sort -rn | head -10 | \
        while read count source; do
            printf "  %-30s %5d\n" "$source" "$count"
        done || echo "  No errors found"
    
    print_section "Most Common Error Messages"
    echo ""
    journalctl --since="$SINCE" -p err --no-pager 2>/dev/null | \
        grep -oP '(?<=]: ).*' | sort | uniq -c | sort -rn | head -10 | \
        while read count msg; do
            printf "  %5d  %.60s\n" "$count" "$msg"
        done || echo "  No error messages found"
}

# Traffic analysis
analyze_traffic() {
    print_header "Log Traffic Analysis"
    
    print_section "Messages per Hour"
    echo ""
    
    # Get hourly distribution
    journalctl --since="$SINCE" --output=short-unix --no-pager 2>/dev/null | \
        awk '{print strftime("%H:00", $1)}' | sort | uniq -c | \
        while read count hour; do
            bar=$(printf '▓%.0s' $(seq 1 $((count / 100 + 1))))
            printf "  %s %6d %s\n" "$hour" "$count" "$bar"
        done || echo "  No data available"
    
    print_section "Log Volume Summary"
    echo ""
    total=$(journalctl --since="$SINCE" --no-pager 2>/dev/null | wc -l)
    echo -e "  Total messages: ${GREEN}$total${NC}"
    
    disk_usage=$(journalctl --disk-usage 2>/dev/null | grep -oP '\d+\.?\d*\s*[GMK]?B?' || echo "unknown")
    echo -e "  Journal disk usage: ${YELLOW}$disk_usage${NC}"
}

# Service analysis
analyze_services() {
    print_header "Service Activity Analysis"
    
    print_section "Most Active Services"
    echo ""
    journalctl --since="$SINCE" --output=json --no-pager 2>/dev/null | \
        jq -r '._SYSTEMD_UNIT // "kernel"' 2>/dev/null | \
        sort | uniq -c | sort -rn | head -15 | \
        while read count unit; do
            printf "  %-40s %6d\n" "$unit" "$count"
        done || echo "  No service data available"
    
    print_section "Service Errors"
    echo ""
    for svc in {{ journal_tools.monitored_services | join(' ') }}; do
        errors=$(journalctl -u "$svc" --since="$SINCE" -p err --no-pager 2>/dev/null | wc -l)
        if [ "$errors" -gt 0 ]; then
            echo -e "  ${RED}$svc: $errors errors${NC}"
        fi
    done
    
    print_section "Service Restarts"
    echo ""
    journalctl --since="$SINCE" --no-pager 2>/dev/null | \
        grep -E "Started|Stopped|Reloading" | \
        grep -oP '(?<=Started |Stopped |Reloading )[^.]+' | \
        sort | uniq -c | sort -rn | head -10 || echo "  No restart data"
}

# User analysis
analyze_users() {
    print_header "User Activity Analysis"
    
    print_section "Active Users (by login)"
    echo ""
    journalctl --since="$SINCE" --no-pager 2>/dev/null | \
        grep -oP 'user=\K\w+|for user \K\w+|by \K\w+' | \
        sort | uniq -c | sort -rn | head -10 || echo "  No user data"
    
    print_section "Sudo Usage by User"
    echo ""
    journalctl _COMM=sudo --since="$SINCE" --no-pager 2>/dev/null | \
        grep -oP '^\w+\s+\d+\s+[\d:]+\s+\S+\s+sudo[^:]*:\s+\K\w+' | \
        sort | uniq -c | sort -rn | head -10 || echo "  No sudo usage"
    
    print_section "SSH Sessions"
    echo ""
    journalctl -u sshd --since="$SINCE" --no-pager 2>/dev/null | \
        grep "session opened" | \
        grep -oP 'for user \K\w+' | \
        sort | uniq -c | sort -rn | head -10 || echo "  No SSH sessions"
}

# Full analysis
full_analysis() {
    echo -e "${MAGENTA}"
    echo "╔═══════════════════════════════════════════════════════════════════╗"
    echo "║              DAPMEET LOG ANALYSIS REPORT                          ║"
    echo "║              $(date '+%Y-%m-%d %H:%M:%S')                             ║"
    echo "╚═══════════════════════════════════════════════════════════════════╝"
    echo -e "${NC}"
    echo -e "${BLUE}Analysis period: $SINCE to now${NC}"
    
    analyze_traffic
    analyze_errors
    analyze_services
    analyze_users
    
    echo ""
    echo -e "${GREEN}═══════════════════════════════════════════════════════════════════${NC}"
    echo -e "${GREEN}                    Analysis Complete                               ${NC}"
    echo -e "${GREEN}═══════════════════════════════════════════════════════════════════${NC}"
}

# Parse arguments
ACTION="full"
while [[ $# -gt 0 ]]; do
    case $1 in
        -s|--since) SINCE="$2"; shift 2 ;;
        -o|--output) OUTPUT_DIR="$2"; shift 2 ;;
        -h|--help) usage ;;
        --errors) ACTION="errors"; shift ;;
        --traffic) ACTION="traffic"; shift ;;
        --services) ACTION="services"; shift ;;
        --users) ACTION="users"; shift ;;
        --full) ACTION="full"; shift ;;
        *) echo "Unknown option: $1"; usage ;;
    esac
done

case $ACTION in
    errors) analyze_errors ;;
    traffic) analyze_traffic ;;
    services) analyze_services ;;
    users) analyze_users ;;
    full) full_analysis ;;
esac

